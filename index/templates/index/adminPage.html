{% extends 'layout/layout.html' %}
{% load static %}

{% block body %}

<style>
    #tagSuggestions .suggestion-item:hover {
        background-color: #f0f0f0;
    }

    /* Para resaltar la sugerencia activa si no tienes bg-light */
    .suggestion-item.active {
        background-color: #95acc4;
    }

    .adminLink:hover {
        color: #fff !important;
        background-color: #8B0000 !important;
        transform: translateY(-5px);
        transition: transform 0.3s ease;
    }
</style>
<style>
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes slideUp {
        from {
            opacity: 1;
            transform: translateY(0);
        }

        to {
            opacity: 0;
            transform: translateY(-20px);
        }
    }

    .slide-down {
        animation: slideDown 0.5s ease forwards;
    }

    .slide-up {
        animation: slideUp 0.5s ease forwards;
    }
</style>


<div class="container-fluid  mt-4">
    <div class="row">
        <div class="">
            <h1>Secci√≥n de administrador </h1>
        </div>
        <div class="col-xl-2 my-3 col-12 col-md-6 my-xl-0 text-center ">
            <button href=""
                class="btn adminLink border border-3 dynamicQuery border-tercero px-2 py-2 text-center text-primary fw-bold w-100"
                data-type="tags" id="tags">Tags</button>

        </div>
        <div class="col-xl-2 my-3 col-12 col-md-6 my-xl-0 text-center ">
            <button href=""
                class="btn adminLink border border-3 dynamicQuery border-tercero px-2 py-2 text-center text-primary fw-bold w-100"
                data-type="artists" id="artists">Artistas</button>

        </div>
        <div class="col-xl-2 my-3 col-12 col-md-6 my-xl-0 text-center ">
            <button href=""
                class="btn adminLink border border-3 dynamicQuery border-tercero px-2 py-2 text-center text-primary fw-bold w-100"
                data-type="chars" id="chars">Personajes</button>

        </div>
        <div class="col-xl-2 my-3 col-12 col-md-6 my-xl-0 text-center ">
            <button href=""
                class="btn adminLink dynamicQuery border border-3 border-tercero px-2 py-2 text-center text-primary fw-bold w-100"
                data-type="games" id="games">Juegos</button>

        </div>
        {% if user.is_superuser and user.is_staff %}

        <div class="col-xl-2 my-3 col-12 col-md-6 my-xl-0 text-center ">
            <button href=""
                class="btn adminLink dynamicQuery border border-3  border-tercero px-2 py-2 text-center text-primary fw-bold w-100"
                data-type="users" id="users">Usuarios</button>

        </div>
        {% endif %}

        {% if user.is_superuser and user.is_staff %}

        <div class="col-xl-1 my-3 col-12 col-md-6 my-xl-0 text-center ">
            <a href="{% url 'admin:index' %}"
                class="btn adminLink  border border-3 border-tercero px-2 py-2 text-center text-primary fw-bold w-100">
                Admin</a>

        </div>
        <div class="col-xl-1 my-3 col-12 col-md-6 my-xl-0 text-center ">
            <a href="{% url 'index:allVideosHide' %}"
                class="btn adminLink  border border-3 border-tercero px-2 py-2 text-center text-primary fw-bold w-100">
                Videos</a>

        </div>
        {% endif %}
    </div>
    {% include 'Index/adminPageTagForm.html' %}
    {% include 'Index/adminPageArtistForm.html' %}
    {% include 'Index/adminPageCharForm.html' %}
    {% include 'Index/adminPageGameForm.html' %}

    {% if user.is_superuser and user.is_staff %}
    {% include 'Index/adminPageUserForm.html' %}


    {% endif %}


</div>


<script>
    document.addEventListener('DOMContentLoaded', () => {
        const imageInputs = document.querySelectorAll('.imageInput');

        imageInputs.forEach(input => {
            input.addEventListener('change', function () {
                const previewId = this.dataset.previewId;
                const imagePreview = document.querySelector(`.imagePreview[data-preview-id="${previewId}"]`);
                const file = this.files[0];

                if (file && imagePreview) {
                    const reader = new FileReader();

                    reader.onload = function (e) {
                        imagePreview.src = e.target.result;
                        imagePreview.classList.remove('d-none');
                    };

                    reader.readAsDataURL(file);
                } else if (imagePreview) {
                    imagePreview.src = "#";
                    imagePreview.classList.add('d-none');
                }
            });
        });
    });



    document.addEventListener('DOMContentLoaded', () => {
        function toggleFormVisibility(formSelector) {
            const all = ['#tagForm', '#artistForm', '#charForm', '#userForm', '#gameForm'];
            all.forEach(sel => {
                const f = document.querySelector(sel);
                if (!f) return;
                if (sel === formSelector) {
                    f.classList.toggle('d-none');
                } else {
                    f.classList.add('d-none');
                }
            });
        }

        const map = {
            tags: '#tagForm',
            artists: '#artistForm',
            chars: '#charForm',
            games: '#gameForm',
            users: '#userForm'
        };

        Object.entries(map).forEach(([btnId, formSel]) => {
            const btn = document.getElementById(btnId);
            if (btn) {
                btn.addEventListener('click', () => {
                    toggleFormVisibility(formSel);
                });
            }
        });
    });
    document.addEventListener('DOMContentLoaded', function () {
        const buttons = document.querySelectorAll('#socialButtons button');
        buttons.forEach(btn => {
            btn.addEventListener('click', () => {
                const net = btn.dataset.net;
                const container = document.getElementById('input-' + net);
                const input = container.querySelector('input, textarea');
                if (container.classList.contains('d-none')) {
                    container.classList.remove('d-none');
                } else {
                    if (input.value.trim() === '') {
                        container.classList.add('d-none');
                    }
                }
            });
        });
    });
    document.addEventListener('DOMContentLoaded', function () {
        const buttons = document.querySelectorAll('#socialButtons button');
        buttons.forEach(btn => {
            btn.addEventListener('click', () => {
                const net = btn.dataset.net;
                const container = document.getElementById('input-' + net);
                const input = container.querySelector('input, textarea');

                if (!container.classList.contains('open')) {
                    container.classList.add('open');
                } else {
                    if (input.value.trim() === '') {
                        container.classList.remove('open');
                    }
                }
            });
        });
    });
    function setupTagInput({ inputId, suggestionsId, containerId, hiddenInputId }) {
        const tagInput = document.getElementById(inputId);
        const tagSuggestions = document.getElementById(suggestionsId);
        const tagContainer = document.getElementById(containerId);
        const tagsSelectedInput = document.getElementById(hiddenInputId);

        let selectedTags = [];
        let selectedIndex = -1;

        tagInput.addEventListener("input", async () => {
            const query = tagInput.value.trim();
            const terms = query.split(" ");
            const lastTerm = terms[terms.length - 1];

            if (lastTerm.length < 1) {
                tagSuggestions.classList.add("d-none");
                tagSuggestions.innerHTML = "";
                selectedIndex = -1;
                return;
            }

            const response = await fetch(`/tags-suggest/?q=${encodeURIComponent(lastTerm)}`);
            const tags = await response.json();

            tagSuggestions.innerHTML = "";
            if (tags.length > 0) {
                tagSuggestions.innerHTML = tags.map(tag => `
            <div class="p-2 suggestion-item" style="cursor:pointer;">
                ${tag}
            </div>
        `).join('');

                tagSuggestions.classList.remove("d-none");

                document.querySelectorAll(`#${suggestionsId} .suggestion-item`).forEach((item, index) => {
                    item.addEventListener("click", () => {
                        addTag(item.textContent);
                        tagInput.value = "";
                        tagSuggestions.classList.add("d-none");
                        selectedIndex = -1;
                        tagInput.focus();
                    });
                });

                selectedIndex = -1;
            } else {
                tagSuggestions.classList.add("d-none");
            }
        });

        tagInput.addEventListener("keydown", e => {
            const suggestions = tagSuggestions.querySelectorAll(".suggestion-item");

            if (e.key === "ArrowDown") {
                e.preventDefault();
                selectedIndex = (selectedIndex + 1) % suggestions.length;
                updateActiveSuggestion(suggestions);
            }
            else if (e.key === "ArrowUp") {
                e.preventDefault();
                selectedIndex = (selectedIndex - 1 + suggestions.length) % suggestions.length;
                updateActiveSuggestion(suggestions);
            }
            else if (e.key === "Tab") {
                if (suggestions.length > 0) {
                    e.preventDefault();
                    const idx = selectedIndex >= 0 ? selectedIndex : 0;
                    addTag(suggestions[idx].textContent);
                    tagInput.value = "";
                    tagSuggestions.classList.add("d-none");
                    selectedIndex = -1;
                }
            }
            else if (e.key === "Enter") {
                e.preventDefault();
                if (suggestions.length > 0 && selectedIndex >= 0) {
                    addTag(suggestions[selectedIndex].textContent);
                } else if (tagInput.value.trim() !== "") {
                    addTag(tagInput.value.trim());
                }
                tagInput.value = "";
                tagSuggestions.classList.add("d-none");
                selectedIndex = -1;
            }
        });


        function updateActiveSuggestion(suggestions) {
            suggestions.forEach((item, index) => {
                if (index === selectedIndex) {
                    item.classList.add("bg-light", "active");
                    item.scrollIntoView({ block: "nearest" });
                } else {
                    item.classList.remove("bg-light", "active");
                }
            });
        }

        function addTag(tagText) {
            const cleanTag = tagText.trim();
            if (cleanTag === "" || selectedTags.includes(cleanTag)) return;

            selectedTags.push(cleanTag);

            const tagDiv = document.createElement("div");
            tagDiv.className = "badge bg-secondary text-white rounded-pill px-3 py-2 d-flex align-items-center gap-2";
            tagDiv.innerHTML = `
        ${cleanTag}
        <button type="button" class="btn-close btn-close-white btn-sm ms-2" aria-label="Remove"></button>
    `;

            tagDiv.querySelector("button").addEventListener("click", () => {
                tagContainer.removeChild(tagDiv);
                selectedTags = selectedTags.filter(t => t !== cleanTag);
                updateHiddenInput();
            });

            tagContainer.appendChild(tagDiv);
            updateHiddenInput();
        }

        function updateHiddenInput() {
            tagsSelectedInput.value = selectedTags.join(",");
        }
    }
    document.querySelectorAll('.tag-input-wrapper').forEach(wrapper => {
        setupTagInput({
            inputId: wrapper.dataset.inputId,
            suggestionsId: wrapper.dataset.suggestionsId,
            containerId: wrapper.dataset.containerId,
            hiddenInputId: wrapper.dataset.hiddenId
        });
    });
</script>

{% endblock %}