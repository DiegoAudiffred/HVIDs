{% extends 'layout/layout.html' %}
{% load static %}

{% block body %}
<div class="container-fluid mt-4">
  <div class="row mb-3">
    <div class="col-12 border-bottom border-3 border-primary">
      <h1 class="fw-bold text-dark">Descargador Multimedia Universal</h1>
    </div>
    <div class="col-12">
      <div id="result" class="mb-4">
        {% if already_downloaded %}
        <div class="alert alert-info border-start border-4 border-info rounded-3" role="alert">
          <i class="fas fa-info-circle me-2"></i>
          El archivo ya estaba: <a href="/media/{{ filename }}" target="_blank" class="alert-link fw-semibold">{{ filename }}</a>
        </div>
        {% elif filename %}
        <div class="alert alert-success border-start border-4 border-success rounded-3" role="alert">
          <i class="fas fa-check-circle me-2"></i>
          ¡Descarga completada! <a href="/media/{{ filename }}" target="_blank" class="alert-link fw-semibold">{{ filename }}</a>
        </div>
        {% elif error %}
        <div class="alert alert-danger border-start border-4 border-danger rounded-3" role="alert">
          <i class="fas fa-exclamation-triangle me-2"></i>
          Error: {{ error }}
        </div>
        {% endif %}
      </div>
    </div>

    <div class="col-12">
      <form method="post" id="download-form">
        {% csrf_token %}

        <div class="mb-4">
          <label for="url-input" class="form-label fw-bold text-primary">URL del video o archivo directo</label>
          <div class="input-group input-group-lg border border-secondary rounded-3 overflow-hidden shadow-sm">
            <span class="input-group-text bg-light border-0" style="color: #007bff;">
              <i class="fas fa-link"></i>
            </span>
            <input id="url-input" class="form-control py-2 px-3 border-0" type="url" name="url"
              placeholder="Pega el enlace de YouTube o link directo (.mp4, .mp3...)" required>
          </div>
        </div>

        <div class="row ">
          <div class="col-lg-6 col-12 my-2">
            <label for="download-type" class="form-label fw-bold text-primary">Formato de Salida</label>
            <select id="download-type" name="download_type"
              class="form-select form-select-lg py-2 rounded-3 shadow-sm border-secondary">
              <option value="video" selected> Video (Original/MP4)</option>
              <option value="audio"> Audio (MP3)</option>
            </select>
          </div>

          <div class="col-lg-6 col-12 my-2">
            <label for="download-btn" class="form-label fw-bold text-white d-none d-md-block">.</label>
            <button id="download-btn" type="submit"
              class="btn btn-primary btn-lg fw-bold text-uppercase py-2 shadow-sm w-100">
              <i class="fas fa-arrow-alt-circle-down me-2"></i> Iniciar Descarga
            </button>
            <button id="cancel-btn" type="button" class="btn btn-outline-danger mt-2" style="display:none;">
              <i class="fas fa-times me-1"></i> Cancelar Proceso
            </button>
          </div>
        </div>
      </form>

      <div id="loading-bar" class="my-4 p-3 rounded-3 bg-light border border-info border-3" style="display:none;">
        <p class="mb-2 fw-semibold text-center text-secondary">
          <i class="fas fa-spinner fa-pulse me-2"></i> Procesando descarga... Esto puede tardar dependiendo del tamaño.
        </p>
        <div class="progress" style="height: 20px;">
          <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" role="progressbar"
            aria-valuenow="100" style="width:100%;"></div>
        </div>
      </div>
    </div>

    <div class="col-12 text-start">
      <div class=" pt-3 ">
        <a href="{% url 'index:viewDownloadedVideos' %}" class="btn btn-sm btn-outline-secondary text-out">
          Ver Descargas
        </a>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('download-form');
    const loading = document.getElementById('loading-bar');
    const result = document.getElementById('result');
    const cancel = document.getElementById('cancel-btn');
    const downloadBtn = document.getElementById('download-btn');

    form.addEventListener('submit', async e => {
      e.preventDefault();

      loading.style.display = 'block';
      result.innerHTML = '';
      cancel.style.display = 'block';
      downloadBtn.disabled = true;
      downloadBtn.innerHTML = '<i class="fas fa-hourglass-half me-2"></i> Procesando...';

      const data = new URLSearchParams(new FormData(form));

      try {
        const resp = await fetch("{% url 'index:videoDownloader' %}", {
          method: 'POST',
          headers: { 'X-CSRFToken': getCookie('csrftoken'), 'X-Requested-With': 'XMLHttpRequest' },
          body: data
        });

        const json = await resp.json();

        if (json.error) {
          result.innerHTML = `<div class="alert alert-danger border-start border-4 border-danger rounded-3" role="alert"><i class="fas fa-exclamation-triangle me-2"></i> Error: ${json.error}</div>`;
        } else {
          const msg = json.already_downloaded ? '✅ Archivo encontrado:' : '✅ ¡Descarga completada!';
          const alertClass = json.already_downloaded ? 'alert-info border-info' : 'alert-success border-success';
          const iconClass = json.already_downloaded ? 'fas fa-info-circle' : 'fas fa-check-circle';

          result.innerHTML = `<div class="alert ${alertClass} border-start border-4 rounded-3" role="alert"><i class="${iconClass} me-2"></i> ${msg} <a href="/media/${json.filename}" target="_blank" class="alert-link fw-semibold">${json.filename}</a></div>`;
        }
      } catch (error) {
        result.innerHTML = `<div class="alert alert-danger border-start border-4 border-danger rounded-3" role="alert"><i class="fas fa-exclamation-triangle me-2"></i> Error de conexión o servidor.</div>`;
      } finally {
        loading.style.display = 'none';
        cancel.style.display = 'none';
        downloadBtn.disabled = false;
        downloadBtn.innerHTML = '<i class="fas fa-arrow-alt-circle-down me-2"></i> Iniciar Descarga';
      }
    });

    cancel.addEventListener('click', () => {
      window.location.reload();
    });

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        document.cookie.split(';').forEach(function (cookie) {
          cookie = cookie.trim();
          if (cookie.startsWith(name + '=')) {
            cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
          }
        });
      }
      return cookieValue;
    }
  });
</script>
{% endblock %}