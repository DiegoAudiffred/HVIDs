{% extends 'layout/layout.html' %}
{% load static %}
{% block body %}

<div class="container-fluid mt-4 ">
    <div class="row align-items-center ">
        <div class="col-12 border-bottom border-3 border-primary">
            <h1 class="fw-bold text-dark">Perfil de {{ user }}</h1>
        </div>

        <!-- Banner para móviles (pantallas < 768px) -->
        <div class="d-lg-none position-relative rounded overflow-hidden border border-secondary my-3"
            style="height: 230px; background-image: url('{% if user.banner %}{{ user.banner.url }}{% else %}{% static 'img/noImage.jpg' %}{% endif %}'); background-size: cover; background-position: center;">

            <img src="{% if user.image %}{{ user.image.url }}{% else %}{% static 'img/noImage.jpg' %}{% endif %}"
                alt="{{ user.username }}"
                class="position-absolute top-0 start-0 m-2 border border-primary rounded-circle shadow"
                style="width: 90px; height: 90px; object-fit: cover;">

            {% if request.user == user %}
            <button type="button"
                class="btn btn-light position-absolute top-0 end-0 p-2 m-2 shadow rounded-circle bg-quinto bg-opacity-50 border-secondary"
                data-bs-toggle="modal" data-bs-target="#perfilModal">
                <img src="{% static 'img/edit.png' %}" alt="Opciones" style="width: 24px; height: 24px;">
            </button>
            {% endif %}

            <div class="position-absolute bottom-0 start-0 end-0 bg-quinto bg-opacity-50 text-white p-2">
                <h6 class="mb-1">{{ user.username }}</h6>
                <small><strong>Publicaciones:</strong> {{ total }}</small><br>
                <small><strong>Likes:</strong> {{ total_likes }}</small>
                <small class="d-flex flex-wrap align-items-center mb-2">
                    <strong class="me-2">Tags favoritos:</strong>
                    {% for tag in favTags %}
                    <a href="{% url 'index:filtered_media' 'tag' tag.name %}"
                        class="btn btn-sm btn-outline-tercero rounded-pill py-0 px-2 btn-sexto me-1 mb-1"
                        style="font-size: 0.75rem; line-height: 1.2;">
                        {{ tag.name }}
                    </a>
                    {% endfor %}
                </small>
                <small><strong>Miembro desde:</strong> {{ user.date_joined }}</small>

            </div>
        </div>

        <!-- Banner para pantallas medianas o mayores (≥ 768px) -->
        <div class="d-none d-lg-block position-relative rounded overflow-hidden border border-4 border-tercero rounded-5 my-3"
            style="height: 340px; background-image: url('{% if user.banner %}{{ user.banner.url }}{% else %}{% static 'img/noImage.jpg' %}{% endif %}'); background-size: cover; background-position: center;">

            <!-- Imagen de perfil -->
            <img src="{% if user.image %}{{ user.image.url }}{% else %}{% static 'img/noImage.jpg' %}{% endif %}"
                alt="{{ user.username }}"
                class="position-absolute top-0 start-0 m-4 border border-quinto rounded-circle shadow"
                style="width: 200px; height: 200px; object-fit: cover;">

            <!-- Información del perfil en la parte superior derecha -->
            <div class="position-absolute top-0 end-0 m-5 bg-tercero bg-opacity-75 text-white p-3 rounded w-50">
                <p class="d-flex flex-wrap align-items-center mb-2">
                    <strong class="me-2">Tags favoritos:</strong>
                    {% for tag in favTags %}
                    <a href="{% url 'index:filtered_media' 'tag' tag.name %}"
                        class="btn btn-sm btn-outline-tercero rounded-pill py-0 px-2 btn-sexto me-1 mb-1"
                        style="font-size: 0.75rem; line-height: 1.2;">
                        {{ tag.name }}
                    </a>
                    {% endfor %}
                </p>
                <p><strong>Miembro desde:</strong> {{ user.date_joined }}</p>
                <p><strong>Publicaciones:</strong> {{ total }}</p>
                <p><strong>Likes dados:</strong> {{ total_likes }}</p>
            </div>

            <!-- Botón de editar al fondo a la derecha -->
            {% if request.user == user %}
            <button type="button"
                class="btn btn-light position-absolute top-0 end-0 p-2 m-2 shadow rounded-circle bg-quinto bg-opacity-50 border-secondary"
                data-bs-toggle="modal" data-bs-target="#perfilModal">
                <img src="{% static 'img/edit.png' %}" alt="Opciones" style="width: 24px; height: 24px;">
            </button>
            {% endif %}
        </div>

    </div>


    <!-- Modal -->
    <div class="modal fade" id="perfilModal" tabindex="-1" aria-labelledby="perfilModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="perfilModalLabel">Opciones del perfil</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>

                <form method="post" enctype="multipart/form-data" action="{% url 'index:userProfile' user %}">
                    {% csrf_token %}

                    <div class="modal-body">
                        <!-- Aquí puedes poner acciones como cambiar imagen, banner, etc -->
                        <div class="text-center my-2">
                            <div>
                                Nombre del usuario:

                            </div>
                            {{formUser.username}}
                        </div>
                        <div class="text-center my-2">
                            <div>
                                Contraseña del usuario:

                            </div>
                            {{formUser.password}}

                        </div>
                        <div class="text-center my-2">
                            <div>
                                Imagen de perfil

                            </div>
                            <label for="imageInput1" style="cursor: pointer;">
                                {% if user.image %}
                                <img src="{{user.image.url}}" alt="Previsualización"
                                    class="img-thumbnail d-block imagePreview w-100 h-auto my-2"
                                    style="max-height: 500px; object-fit: contain;" data-preview-id="1">
                                {% else %}
                                <img src="{% static 'img/noImage.jpg' %}" alt="Previsualización"
                                    class="img-thumbnail d-block imagePreview w-100 h-auto"
                                    style="max-height: 500px; object-fit: contain;" data-preview-id="1">
                                {% endif %}
                            </label>
                            <input type="file" name="image" id="imageInput1" accept="image/*" class="d-none imageInput"
                                data-preview-id="1">


                        </div>
                        <div class="text-center my-2">
                            <div> Imagen del banner
                            </div>
                            <label for="imageInput2" style="cursor: pointer;">

                                {% if user.banner %}

                                <img src="{{user.banner.url}}" alt="Previsualización"
                                    class="img-thumbnail d-block imagePreview w-100 h-auto my-2"
                                    style="max-height: 500px; object-fit: contain;" data-preview-id="2">
                                {% else %}
                                <img src="{% static 'img/noImage.jpg' %}" alt="Previsualización"
                                    class="img-thumbnail d-block imagePreview w-100 h-auto"
                                    style="max-height: 500px; object-fit: contain;" data-preview-id="2">
                                {% endif %}
                            </label>

                            <input type="file" name="banner" id="imageInput2" accept="image/*" class="d-none imageInput"
                                data-preview-id="2">


                        </div>


                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary text-white"
                                data-bs-dismiss="modal">Cerrar</button>
                            <button type="submit" class="btn btn-primary">Guardar
                                cambios</button>
                        </div>
                    </div>
                </form>

            </div>
        </div>
    </div>


    {% if combined_media %}
    <div class="col-12 border-bottom border-3 border-primary">
        <h4 class="fw-bold text-dark">Recientes subidos por {{user}}</h4>
    </div>
    <div class="row mt-4">
        {% for item in combined_media %}
        <div class="col-lg-3 col-md-6 mb-4 col-12">
            <div
                class="card h-100 shadow-sm rounded-4 overflow-hidden hover-shadow rainbow-hover border-3 border-primary">
                {% if item.tipo_objeto == 'comic' %}
                <a href="{% url 'index:watchComic' item.id %}">
                    {% else %}
                    <a href="{% url 'index:watchVideo' item.id %}">
                        {% endif %}
                        <div class="position-relative" style="aspect-ratio: 1 / 1; overflow: hidden;">
                            {% if item.image %}
                            <img src="{{ item.image.url }}" alt="{{ item.name }} Thumbnail"
                                class="card-img-top w-100 h-100 object-fit-cover">
                            {% else %}
                            <img src="{% static 'img/noImage.jpg' %}" alt="Sin imagen"
                                class="card-img-top w-100 h-100 object-fit-cover">
                            {% endif %}
                        </div>
                    </a>

                    <div class="card-body d-flex flex-column py-1 bg-quinto px-1">
                        <div class="d-flex justify-content-between align-items-center">
                            {% if item.file %} <img src="{% static 'img/videopng.png' %}" alt="Liked" width="36px"
                                height="36px" class="me-2 ms-0">
                            {% else %} <img src="{% static 'img/comicpng.png' %}" alt="Liked" width="36px" height="36px"
                                class="me-2 ms-0 ">
                            {% endif %}
                            <h5 class="card-title fw-bold text-white text-truncate mb-0">
                                {{ item.name }}
                            </h5>
                            <div class="d-flex align-items-center">
                                <img src="{% static 'img/Liked.png' %}" alt="Liked" width="24px" height="24px">
                                <span class="ms-1 text-white">{{ item.total_likes }}</span>
                            </div>
                        </div>







                    </div>
            </div>
        </div>

        {% endfor %}
        <div class="col-12">
            <a href="">Ver todos los subidos</a>

        </div>
    </div>

    {% else %}
    <p>Este usuario no ha subido nada aun unu</p>
    {% endif %}
    <!-- Tags -->



    <!-- Tags -->

    <!-- MediaFiles -->
    <h3 class="mt-4">Videos Recientemente Gustados</h3>
    {% if mediafiles %}
    <div class="row">
        {% for mediafile in mediafiles %}
         {% include 'index/cardsTemplate.html' %}

        {% endfor %}
    </div>
    <div class="col-12">
        <a href="">Ver todos los likes de videos</a>

    </div>
    {% else %}
    <p>Nada que mostrar.</p>
    {% endif %}

    <!-- Artistas -->
    <h3 class="mt-4">Artistas Recientemente Gustados</h3>
    {% if artists %}
    <div class="row">
        {% for item in artists %}
        <div class="col-lg-3 col-md-6 mb-4 col-12">
            <a href="{% url 'index:detailsAbout' 'artist' item.name %}" class="text-decoration-none text-dark">
                <div class="card shadow-sm h-100">
                    {% if item.image %}

                    <img src="{{ item.image.url }}" class="card-img-top img-fixed" alt="{{ item.name }}" style="width: 100%;
                    height: 300px; /* o el alto que desees */
                    object-fit: cover;">

                    {% else %}

                    <img src="{% static 'img/noImage.jpg' %}" alt="Previsualización" class="card-img-top img-fixed"
                        style="width: 100%;
                    height: 300px; /* o el alto que desees */
                    object-fit: cover;" alt="{{ item.name }}">

                    {% endif %}
                    <div class="card-body">
                        <h5 class="card-title text-center text-truncate">{{ item.name }}</h5>
                    </div>
                </div>
            </a>
        </div>
        {% endfor %}
    </div>
    <div class="col-12">
        <a href="">Ver todos los likes de artistas</a>

    </div>
    {% else %}
    <p>Nada que mostrar.</p>
    {% endif %}

    <!-- Cómics -->
    <h3 class="mt-4">Imagenes Recientemente Gustadas</h3>
    {% if comics %}
    <div class="row">
        {% for mediafile in comics %}
        {% include 'index/cardsTemplate.html' %}

        {% endfor %}
    </div>
    <div class="col-12">
        <a href="">Ver todos los likes de imagenes</a>

    </div>
    {% else %}
    <p>Nada que mostrar.</p>
    {% endif %}

    <!-- Personajes -->
    <h3 class="mt-4">Personajes Recientemente Gustados</h3>
    {% if characters %}
    <div class="row">
        {% for item in characters %}
        <div class="col-lg-3 col-md-6 mb-4 col-12">
            <a href="{% url 'index:detailsAbout' 'character' item.name %}" class="text-decoration-none text-dark">
                <div class="card shadow-sm h-100">
                    {% if item.image %}

                    <img src="{{ item.image.url }}" class="card-img-top img-fixed" alt="{{ item.name }}" style="width: 100%;
                    height: 300px; /* o el alto que desees */
                    object-fit: cover;">

                    {% else %}

                    <img src="{% static 'img/noImage.jpg' %}" alt="Previsualización" class="card-img-top img-fixed"
                        style="width: 100%;
                    height: 300px; /* o el alto que desees */
                    object-fit: cover;" alt="{{ item.name }}">

                    {% endif %}
                    <div class="card-body">
                        <h5 class="card-title text-center text-truncate">{{ item.name }}</h5>
                    </div>
                </div>
            </a>
        </div>
        {% endfor %}
    </div>
    <div class="col-12">
        <a href="">Ver todos los likes de personajes</a>

    </div>
    {% else %}
    <p>Nada que mostrar.</p>
    {% endif %}

    <!-- Juegos -->
    <h3 class="mt-4">Juegos Recientemente Gustados</h3>
    {% if games %}
    <div class="row">
        {% for item in games %}
        <div class="col-lg-3 col-md-6 mb-4 col-12">
            <a href="{% url 'index:detailsAbout' 'game' item.name %}" class="text-decoration-none text-dark">
                <div class="card shadow-sm h-100">
                    {% if item.image %}
                    <img src="{{ item.image.url }}" class="card-img-top img-fixed" alt="{{ item.name }}" style="width: 100%;
                    height: 300px; /* o el alto que desees */
                    object-fit: cover;">

                    {% else %}

                    <img src="{% static 'img/noImage.jpg' %}" alt="Previsualización" class="card-img-top img-fixed"
                        style="width: 100%;
                    height: 300px; /* o el alto que desees */
                    object-fit: cover;" alt="{{ item.name }}">

                    {% endif %}
                    <div class="card-body">
                        <h5 class="card-title text-center text-truncate">{{ item.name }}</h5>
                    </div>
                </div>
            </a>
        </div>
        {% endfor %}
    </div>
    <div class="col-12">
        <a href="">Ver todos los likes de juegos</a>

    </div>
    {% else %}
    <p>Nada que mostrar.</p>
    {% endif %}
</div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const imageInputs = document.querySelectorAll('.imageInput');

        imageInputs.forEach(input => {
            input.addEventListener('change', function () {
                const previewId = this.dataset.previewId;
                const imagePreview = document.querySelector(`.imagePreview[data-preview-id="${previewId}"]`);
                const file = this.files[0];

                if (file && imagePreview) {
                    const reader = new FileReader();

                    reader.onload = function (e) {
                        imagePreview.src = e.target.result;
                        imagePreview.classList.remove('d-none');
                    };

                    reader.readAsDataURL(file);
                } else if (imagePreview) {
                    imagePreview.src = "#";
                    imagePreview.classList.add('d-none');
                }
            });
        });
    });

</script>
{% endblock %}