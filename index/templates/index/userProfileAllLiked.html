def stream_video(request, id):
try:
media = MediaFile.objects.get(id=id)
except MediaFile.DoesNotExist:
return HttpResponseNotFound("Archivo no encontrado")

path = os.path.join(settings.MEDIA_ROOT, media.file.name)

if not os.path.exists(path):
return HttpResponseNotFound("Archivo no encontrado en disco")

size = os.path.getsize(path)
range_header = request.headers.get('Range', None)
content_type = 'video/mp4'

if range_header:
byte_range = range_header.replace('bytes=', '').split('-')
start = int(byte_range[0])
end = int(byte_range[1]) if byte_range[1] else size - 1

if start >= size:
return HttpResponse(status=416)

length = end - start + 1

def file_iterator(file_path, offset, chunk_len, chunk_size=8192):
with open(file_path, 'rb') as f:
f.seek(offset)
remaining = chunk_len
while remaining > 0:
read_size = min(remaining, chunk_size)
data = f.read(read_size)
if not data:
break
yield data
remaining -= len(data)

response = StreamingHttpResponse(file_iterator(path, start, length), status=206, content_type=content_type)
response['Content-Range'] = f'bytes {start}-{end}/{size}'
response['Content-Length'] = str(length)
else:
response = FileResponse(open(path, 'rb'), content_type=content_type)
response['Content-Length'] = str(size)

response['Accept-Ranges'] = 'bytes'
return response