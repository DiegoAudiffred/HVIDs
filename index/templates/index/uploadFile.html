<!-- uploadFile.html -->
{% extends 'layout/layout.html' %}
{% block body %}
<style>
    .upload-card {
        border-radius: 1.5rem;
        border: none;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        background-color: #fff;
    }

    /* Estilo para los botones de tipo de contenido */
    .btn-check:checked+.btn-outline-primary {
        background-color: var(--bs-primary);
        color: white;
        box-shadow: 0 4px 12px rgba(var(--bs-primary-rgb), 0.3);
    }

    /* Caja de subida mejorada */
    #uploadBox {
        border: 2px dashed #dee2e6;
        border-radius: 1rem;
        transition: all 0.3s ease;
        background: #f8f9fa;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 150px;
    }

    #uploadBox:hover {
        border-color: var(--bs-primary);
        background: rgba(var(--bs-primary-rgb), 0.05);
        color: var(--bs-primary);
    }

    /* Previsualización de imágenes */
    .preview-wrapper {
        position: relative;
        width: 120px;
    }

    .preview-img {
        width: 120px;
        height: 150px;
        object-fit: cover;
        border-radius: 0.75rem;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .btn-remove-preview {
        position: absolute;
        top: -5px;
        right: -5px;
        padding: 0.2rem 0.5rem;
        font-size: 0.7rem;
        border-radius: 50%;
        z-index: 2;
    }

    /* Sugerencias de etiquetas */
    .suggestion-item {
        cursor: pointer;
        transition: background 0.2s;
    }

    .suggestion-item:hover,
    .suggestion-item.active {
        background-color: var(--bs-primary) !important;
        color: white;
    }

    /* Inputs estilo "Pill" */
    .form-control-pill {
        border-radius: 2rem;
        padding-left: 1.5rem;
        border: 2px solid #eee;
    }

    .form-control-pill:focus {
        border-color: var(--bs-primary);
        box-shadow: none;
    }
</style>

<div class="container-fluid mt-4 ">
    <div class="row align-items-center ">
        <div class="col-12 border-bottom border-3 border-primary">
            <h1 class="fw-bold text-dark">Subir nuevo elemento</h1>
        </div>
        <div class="col-12 col-lg-6 text-center my-3">
            <button class="btn border-4 rounded-4 w-100 bg-primary text-cuarto fw-bold"
                id="comicBtn">Imagen/Galería</button>
        </div>
        <div class="col-12 col-lg-6 text-center my-3">
            <button class="btn border-4 rounded-4 w-100 bg-secondary text-cuarto fw-bold"
                id="videoBtn">Video/Canción</button>
        </div>

    </div>


    {% include 'Index/uploadComic.html' %}
    {% include 'Index/uploadVideo.html' %}



</div>


<!-- SCRIPT de mostrar formulario Comic/Video (opcional si manejas tabs) -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const comicBtn = document.getElementById('comicBtn');
        const videoBtn = document.getElementById('videoBtn');

        const comicForm = document.getElementById('comicForm');
        const videoForm = document.getElementById('videoForm');

        function showForm(formToShow) {
            const forms = [comicForm, videoForm];
            forms.forEach(form => {
                form.style.display = (form === formToShow) ? 'block' : 'none';
            });
        }

        if (comicBtn) {
            comicBtn.addEventListener('click', function () {
                showForm(comicForm);
            });
        }
        if (videoBtn) {
            videoBtn.addEventListener('click', function () {
                showForm(videoForm);
            });
        }
    });
</script>

<script>
    function setupTagInput({ inputId, suggestionsId, containerId, hiddenInputId }) {
        const tagInput = document.getElementById(inputId);
        const tagSuggestions = document.getElementById(suggestionsId);
        const tagContainer = document.getElementById(containerId);
        const tagsSelectedInput = document.getElementById(hiddenInputId);

        let selectedTags = [];
        let selectedIndex = -1;

        tagInput.addEventListener("input", async () => {
            const query = tagInput.value.trim();
            const terms = query.split(" ");
            const lastTerm = terms[terms.length - 1];

            if (lastTerm.length < 1) {
                tagSuggestions.classList.add("d-none");
                tagSuggestions.innerHTML = "";
                selectedIndex = -1;
                return;
            }

            const response = await fetch(`/tags-suggest/?q=${encodeURIComponent(lastTerm)}`);
            const tags = await response.json();

            tagSuggestions.innerHTML = "";
            if (tags.length > 0) {
                tagSuggestions.innerHTML = tags.map(tag => `
                <div class="p-2 suggestion-item" style="cursor:pointer;">
                    ${tag}
                </div>
            `).join('');

                tagSuggestions.classList.remove("d-none");

                document.querySelectorAll(`#${suggestionsId} .suggestion-item`).forEach((item, index) => {
                    item.addEventListener("click", () => {
                        addTag(item.textContent);
                        tagInput.value = "";
                        tagSuggestions.classList.add("d-none");
                        selectedIndex = -1;
                        tagInput.focus();
                    });
                });

                selectedIndex = -1;
            } else {
                tagSuggestions.classList.add("d-none");
            }
        });

        tagInput.addEventListener("keydown", e => {
            const suggestions = tagSuggestions.querySelectorAll(".suggestion-item");

            // Flechas arriba/abajo mantienen tu lógica
            if (e.key === "ArrowDown") {
                e.preventDefault();
                selectedIndex = (selectedIndex + 1) % suggestions.length;
                updateActiveSuggestion(suggestions);
            }
            else if (e.key === "ArrowUp") {
                e.preventDefault();
                selectedIndex = (selectedIndex - 1 + suggestions.length) % suggestions.length;
                updateActiveSuggestion(suggestions);
            }
            // Tab: si moviste con flechas, toma esa; si no, la primera sugerencia
            else if (e.key === "Tab") {
                if (suggestions.length > 0) {
                    e.preventDefault();
                    const idx = selectedIndex >= 0 ? selectedIndex : 0;
                    addTag(suggestions[idx].textContent);
                    tagInput.value = "";
                    tagSuggestions.classList.add("d-none");
                    selectedIndex = -1;
                }
            }
            // Enter: si moviste con flechas, toma esa; sino, toma lo que escribiste
            else if (e.key === "Enter") {
                e.preventDefault();
                if (suggestions.length > 0 && selectedIndex >= 0) {
                    addTag(suggestions[selectedIndex].textContent);
                } else if (tagInput.value.trim() !== "") {
                    addTag(tagInput.value.trim());
                }
                tagInput.value = "";
                tagSuggestions.classList.add("d-none");
                selectedIndex = -1;
            }
        });


        function updateActiveSuggestion(suggestions) {
            suggestions.forEach((item, index) => {
                if (index === selectedIndex) {
                    item.classList.add("bg-light", "active");
                    item.scrollIntoView({ block: "nearest" });
                } else {
                    item.classList.remove("bg-light", "active");
                }
            });
        }

        function addTag(tagText) {
            const cleanTag = tagText.trim();
            if (cleanTag === "" || selectedTags.includes(cleanTag)) return;

            selectedTags.push(cleanTag);

            const tagDiv = document.createElement("div");
            tagDiv.className = "badge bg-secondary text-white rounded-pill px-3 py-2 d-flex align-items-center gap-2";
            tagDiv.innerHTML = `
            ${cleanTag}
            <button type="button" class="btn-close btn-close-white btn-sm ms-2" aria-label="Remove"></button>
        `;

            tagDiv.querySelector("button").addEventListener("click", () => {
                tagContainer.removeChild(tagDiv);
                selectedTags = selectedTags.filter(t => t !== cleanTag);
                updateHiddenInput();
            });

            tagContainer.appendChild(tagDiv);
            updateHiddenInput();
        }

        function updateHiddenInput() {
            tagsSelectedInput.value = selectedTags.join(",");
        }
    }
    setupTagInput({
        inputId: "tagInputVideo",
        suggestionsId: "tagSuggestionsVideo",
        containerId: "tagContainerVideo",
        hiddenInputId: "tagsSelectedVideo"
    });

    setupTagInput({
        inputId: "tagInputComic",
        suggestionsId: "tagSuggestionsComic",
        containerId: "tagContainerComic",
        hiddenInputId: "tagsSelectedComic"
    });

</script>




{% endblock %}